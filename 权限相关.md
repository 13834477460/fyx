## 权限相关（非常重要）

权限控制：要控制登录系统的用户，能看到哪些菜单(代码控制) 这叫权限的控制

权限的数据操作：登录系统的用户哪里来(数据)?这些用户又具有什么身份(角色)(数据)?每个角色应该展示哪些菜单(数据)? 这些数据的来源 叫做权限数据操作

#### 目前网页的功能相关模块

  1、首页
  2、商品管理相关所有功能

#### 想要达到的效果

  首页的功能可以让所有用户操作
  商品管理的功能只让有资格（权限信息数据）的用户操作

#### 两个用户   admin   test

  admin 是超级用户，网页所有的功能都有权限操作，拥有所有的功能权限信息数据
  test 是我们自己创建的用户，网页上只有部分功能有权限操作，拥有部分的功能权限信息数据

  他们的权限数据怎么来的，目前先不用管，最后再说



#### 步骤:

第一步: 用户登录，每个用户都拥有自己的权限数据
第二步: 权限信息数据，用户决定路由当中配置的是哪些路由(决定router路由器中注册哪些路由)
第三步: 路由的配置最终控制菜单显示哪些(决定侧边栏展示哪些菜单)
	

### 路由(菜单)权限操作

根据登录后用户的权限信息数据，决定网页功能是否能被这个用户操作

1. 查看用户登录的数据

   用户拿到的路由权限数据，是相关的路由name字符串数组，可以实现路由权限操作
   这个数组决定这个用户能看到的路由页面
   路由器当中注册了哪些路由，用户就能看到哪些页面

   

   例如: 数组中有 Product Attr 用户才能看到商品管理和属性管理的组件页面
   代表用户信息决定了路由器当中注册了这些路由

   

   这些我们要意识到： 
   **用户返回的路由信息决定了（路由器当中注册的是那些路由）进而决定用户能看到哪些页面**

   

   **用户拿到的按钮权限数据，是相关的按钮权限标识字符串数组，可以实现按钮权限操作**
   **这个数组决定这个用户能看到的路由页面信息的按钮，后面说**

   

   **用户拿到的角色权限数据，是相关的角色的名称**
   **为了后面分配权限用的，后面说**

   

2. 路由数组的组成
   现在要根据用户的路由权限数据决定路由当中注册哪些路由，那么我们的路由就要改变，分为以下三种

   > 注意：我们的路由器里面，不能所有的路由都直接使用常量路由注册，否则所有用户都可以操作，没法实现路由权限操作
   > 而目前我们都是用的常量路由，所以两个用户都能看到商品管理相关路由页面 

   

   * 常量路由
     常量路由是任意用户都能操作的路由，就是都能看到这个路由组件

     

   * 异步路由
     异步路由就是权限路由，用户拥有这个路由对应的name信息，这个路由组件才能被用户操作，才能看到

     

   * 任意路由
     任意路由，随意的不合法的路由，全部转向404组件页面，添加路由器的时候，必须最后一个注册

     

3. 根据用户路由权限数据信息决定最后路由器里面注册的都是哪些路由

   1. 修改路由当中注册的路由为三种不同的路由  **常量路由、异步路由、任意路由**

   2. 创建路由器的时候只能注册常量路由

   3. 获取用户信息的时候，真正的根据用户权限数据信息决定路由当中有哪些异步路由

      存储用户权限信息相关
      存储用户的角色信息
      存储用户的按钮权限信息

      通过返回的用户的路由名称数组，从所有的异步路由数组当中，过滤出用户自己的异步路由数组，然后将常量路由、异步路由、任意路由拼接存储到用户信息中，用于在sidebar侧边栏展示菜单

      > 注意：完成这一步的时候，只是侧边栏展示出来了，点击侧边菜单跳转不到目标页面，路由在初始化注册的时候只注册了常量路由，并没有在路由器当中注册异步路由和任意路由

4. 设置用户路由的时候可以使用动态添加路由，把异步路由和任意路由添加到路由器的路由当中

   ```js
   // router.addRoutes([...routes,anyRoutes])  --->  废弃了,老项目中可能见到
   
   const addRoutes = (routes: RouteRecordRaw[]) => {
     routes.forEach(route => {
       router.addRoute(route);
     })
   }
   ```





总结:

路由（菜单）权限的控制

全局路由导航守卫当中获取用户的菜单权限数据信息

根据用户的菜单权限数据信息，从所有的异步路由当中过滤出当前用户自己的异步路由，展示侧边栏

同时使用路由器的动态添加路由，将用户的异步路由和任意路由，动态添加到路由器当中



bug：

第一次:  只登录admin展示没有问题

第二次: 只登录user12展示没有问题

第三次: 先登录admin退出之后再登录user12没有问题

第四次: 先登录user12退出之后再登录admin - 展示的菜单栏只有user12这个账户有权限的菜单了吧

为什么?

当第一次登录的时候，使用的是 user12 这个账户，它的权限比较低，直接过滤路由中的子集路由的时候，重新赋值了，重新赋值之后，asyncRoutes这里面的路由就不完整了，把没有权限的子集路由给丢失了，

退出登录之后再次使用admin登录的时候，是高权限用户，它应该所有的路由都可以展示，但是现在的asyncRoutes不完整了，现在拿着不完整的asyncRoutes去过滤，找不回之前(user12登录没有权限的路由)丢失的路由了

解决方案: 在过滤之前深拷贝一下原始数据即可



> 笔记
>
> 测试权限的数据管理
> 1. 菜单管理页面 - 添加一个菜单 - 有2个子菜单
> 2. 创建一个角色 - 给当前角色分配菜单权限, 当分配完菜单权限之后,角色和菜单之间的联系就建立了
> 3. 创建一个用户 - 给当前用户分配角色, 当分配角色之后,用户和角色之间的联系就建立了
>     (一会自己用户的时候,如果抛一个很长的 mysql 的错误,是后端的问题不是我们问题 - 用户名之前被使用过,如果报错取一个特殊一点的名字即可)
>     注意:
>     项目中想要展示这个菜单,一定要有路由,拿着项目中的路由 去和 用户信息返回权限数据接口 进行筛选的
>
> 权限管理:
> 直接粘贴已完成项目的代码(前两天在群里发的哪个完成版代码)
> 1. 粘贴路由 - 异步路由中的权限管理路由
> 2. 粘贴组件 - src/views/acl 这个文件夹
> 3. 粘贴api -  src/api/acl 这个文件夹



### 权限数据管理

权限的控制和权限的数据管理不是一回事

权限的控制，是根据用户的权限数据，决定功能哪些可以操作

权限数据的管理，是说的用户的权限数据怎么增删改查



#### 增加权限数据管理

演示添加用户、添加角色、添加权限以及给角色授权、给用户添加角色

复制已完成的 api 当中的acl

复制已完成的 views 当中定义好的acl组件

复制已完成的 routes 当中定义好的acl路由配置



### 串讲用户、角色、权限

#### 用户的增删改查

 查询的时候注意、搜索的对象和输入收集的对象不是同一个

搜索的时候我们输入用户名，用户名就被收集到一个对象tempObject
点击搜索，就会发请求，假设就只有这一个对象，那么发请求就是用tempObject发请求的
再次输入数据，不点搜索按钮，直接翻页就会出问题，翻页就不是拿的原来的数据，而是新的数据

用两个对象处理，一个专门收集数据，一个专门发请求用的数据


用户进行角色授权，不确定的checkbox属性



#### 角色的增删改查

修改角色和确定按钮 同时只能出现一个  编辑模式和查看模式设置

tree结构的用法：下去都查一下官网



#### 权限路由增删改查

操作添加一个新的菜单，添加的时候注意大小写





> 假设
>
> 你是公司主管，管的就是商品上架这块内容，现在来了一个实习生，实习生需要了解业务，也需要给实习生开一个账号，需要让实习生看到商品管理的所有页面，但是能让实习生在这些页面操作吗？
>
> 不能，万一实习生手都上架错了商品，这就是事故，事故是要担责任的，问责从你这个主管开始，所以给实习生开账号的时候，可以让实习生看到所有的页面但是不能操作，这就涉及到按钮级别权限

### 按钮级别权限

按钮级别的权限是依赖于菜单的权限

为用户分配角色分配权限完成

书写工具函数在组件当中进行按钮权限的校验





权限管理作业:

权限的控制: 3遍,从点击登录按钮往后都要删掉重新写,把 store当中的actions 和 beforeEach 中的内容要删掉，子集重新写

权限数据的操作: 第一遍可以CV，第二遍不允许没见过的复制粘贴(看没见过的element的组件使用说明)









## 上线演示

1. 打包dist文件

   > 注意：TS类型检查报错的时候，打包会失败，会给出错误提示，找到提示的位置，将错误解决之后重新打包即可

2. 服务器配置相关 - 购买服务器

   * 选择系统镜像 **centOS 7.6**
   * 创建好服务器之后进来**先改密码**(重装系统之后也是先改密码 - 这个密码需要记住,登录服务器用)
   * 配置防火墙，允许FTP 端口21、端口22访问(这两个端口就是本机可以使用软件链接远端服务器)

3. 使用Linux指令将dist文件上传到指定路径

   Linux指令：cd     cd ../      ls    mkdir     rm -rf     pwd  等指令

   注意：上传文件到指定位置中的指定位置是 nginx 配置中的位置

   > PuTTY 软件用于连接服务器,对服务器进行操作用的(需要用户名和密码,这个用户名和密码是服务器的用户名和密码,在腾讯云中重置密码的时候显示用户名),使用 PuTTY 登录服务器的时候是看不到密码的输入的，自己输入对了回车就进入服务器
   >
   > FileZilla 软件用于上传文件用(我们打包的dist文件,将通过这个软件上传到服务器)
   >
   > 

4. nginx简介

   nginx帮我们做简易的web服务器，怎么访问Ip找到dist文件访问

   nginx帮我们去做代理转发，因为生产环境没有dev-server

5. 正向代理：

   ​    帮客户端实现  用户很明确的知道数据来源（数据目的地网站）

   反向代理：
   	帮服务器实现  用户根本不知道数据来源

6. yum install nginx          			     CentOS里面安装nginx

   yum remove nginx    					卸载

   sudo apt-get install nginx			ubuntu安装

7. 配置nginx服务和代理

   ```sh
   cd   /etc/nginx
   vim  nginx.conf
   ```

   > 注意：如果有权限问题需要修改第一行
   > user root;

   ```sh
   server {
       listen       80 default_server;
       listen       [::]:80 default_server;
       server_name  _;
       root         /root/lqm/www/gulishop-client/dist;
   
       include /etc/nginx/default.d/*.conf;
   
       location / {
           root       /root/lqm/www/gulishop-client/dist;
           index      index.html;
           try_files  $uri $uri/ /index.html;
       }
   
       # 反向代理
       location /api {
           proxy_pass http://gmall-h5-api.atguigu.cn;
       }
   }
   ```

   ```sh
   server {
       listen       5555;
       listen       [::]:5555;
       server_name  _;
       root         /root/lqm/www/gshop-admin_base/dist;
   
       location / {
               root       /root/lqm/www/gshop-admin_base/dist;
               index      index.html;
               try_files  $uri $uri/ /index.html;
       }
   
       # 反向代理
       location /app-prod/ {
       		# 如果需要重写路径的时候,把代理url的末尾加上/
               proxy_pass http://gmall-h5-api.atguigu.cn/;
       }
   
       # Load configuration files for the default server block.
       include /etc/nginx/default.d/*.conf;
   
       error_page 404 /404.html;
       location = /404.html {
       }
   
       error_page 500 502 503 504 /50x.html;
       location = /50x.html {
       }
   }
   ```

   

8. 重启nginx服务

   > cent os6
   >
   > service nginx start
   >
   > service nginx restart
   >
   > service nginx stop

   

   cent os7 指令

   systemctl start nginx            --- 启动nginx

   systemctl restart nginx        --  重启nginx

   systemctl nginx stop            -- 停止nginx











Windows 为图形化操作形式，Linux 一般使用命令与系统进行交互，常用的命令有：

| 命令                                      | 介绍                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| touch 文件名                              | 创建一个文件                                                 |
| pwd                                       | 查看当前位置的绝对路劲                                       |
| mkdir 文件夹名称                          | 创建文件夹（make directory）                                 |
| <span style="color:red">ls</span>         | 查看文件夹下的文件 （list 单词的缩写）                       |
| <span style="color:red">cd</span>         | 改变工作目录，（change directory 缩写）                      |
| Tab                                       | 路径自动补全                                                 |
| clear                                     | 清屏（也可以使用 <span style="color:red">ctrl + l </span> 快捷键） |
| rm 文件名                                 | 删除文件或文件夹                                             |
| rm -rf 文件名                             | 强制删除(慎用)                                               |
| echo 文本 > 文件名                        | 文件写入文本                                                 |
| cat 文件名                                | 查看文件内容                                                 |
| <span style="color:red">ctrl + c</span>   | 取消命令                                                     |
| cp  文件名1  文件名2                      | 复制[文件名1]粘贴[文件名2]                                   |
| mv 文件名1 文件名2                        | [文件名1]重命名[文件名2]                                     |
| mv 文件名1 路径                           | [文件名1]移动到[路径]                                        |
| <span style="color:red">上下方向键</span> | 查看命令历史                                                 |
